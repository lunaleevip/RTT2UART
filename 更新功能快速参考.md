# XexunRTT 自动更新功能快速参考

## 🎯 一分钟上手

### 本地测试（开发环境）

```bash
# 1. 一键启动测试
quick_test_update.bat

# 或手动步骤
python switch_update_server.py test         # 切换到测试模式
python test_update_local.py                # 启动测试服务器
python test_update_cli.py all              # 运行所有测试
```

### 发布更新（生产环境）

```bash
# 1. 切换到生产模式
python switch_update_server.py production

# 2. 生成补丁和版本文件
python deploy_update.py --interactive

# 3. 上传到服务器
# 将 updates/ 目录上传到您的HTTP服务器
```

---

## 📁 文件速查

| 文件 | 功能 | 使用场景 |
|------|------|---------|
| `auto_updater.py` | 核心更新逻辑 | 已集成到程序 |
| `update_dialog.py` | 更新UI界面 | 已集成到程序 |
| `switch_update_server.py` | 切换测试/生产模式 | **⭐ 常用** |
| `test_update_local.py` | 本地测试服务器 | **⭐ 测试必备** |
| `test_update_cli.py` | 命令行测试工具 | **⭐ 快速验证** |
| `quick_test_update.bat` | 一键测试 | **⭐ 最简单** |
| `generate_patch.py` | 生成补丁（底层） | 高级用户 |
| `deploy_update.py` | 部署工具（推荐） | **⭐ 发布更新** |
| `quick_deploy.bat` | 一键部署 | Windows发布 |

---

## 🔧 常用命令

### 配置管理

```bash
# 查看当前模式
python switch_update_server.py

# 测试模式 → 生产模式
python switch_update_server.py production

# 生产模式 → 测试模式
python switch_update_server.py test

# 自定义服务器
python switch_update_server.py custom https://my-server.com/updates
```

### 测试命令

```bash
# 测试配置
python test_update_cli.py config

# 测试服务器连接
python test_update_cli.py connect

# 测试检查更新
python test_update_cli.py check

# 运行所有测试
python test_update_cli.py all
```

### 部署命令

```bash
# 交互式部署（推荐）
python deploy_update.py --interactive

# 命令行部署
python deploy_update.py \
    --new-version 2.3.0 \
    --new-file XexunRTT_v2.3.0.exe \
    --old-versions XexunRTT_v2.2.0.exe \
    --release-notes "修复XX问题"
```

---

## 🚦 工作流程

### 开发测试流程

```
编译新版本
   ↓
切换到测试模式 (python switch_update_server.py test)
   ↓
启动测试服务器 (python test_update_local.py)
   ↓
运行测试 (python test_update_cli.py all)
   ↓
验证更新功能
   ↓
切换回生产模式 (python switch_update_server.py production)
```

### 发布更新流程

```
编译新版本
   ↓
确认在生产模式 (python switch_update_server.py)
   ↓
生成补丁 (python deploy_update.py --interactive)
   ↓
上传到服务器 (SCP/FTP)
   ↓
验证 (python test_update_cli.py connect)
   ↓
通知用户更新
```

---

## 🎨 配置优先级

```
1️⃣ update_config.ini (文件)
    ↓ 没有
2️⃣ XEXUNRTT_UPDATE_SERVER (环境变量)
    ↓ 没有
3️⃣ PRODUCTION_SERVER (代码默认值)
```

---

## 📊 更新效果

| 更新类型 | 下载大小 | 节省流量 | 时间(1Mbps) |
|---------|---------|---------|------------|
| Bug修复 | 2-5 MB | 89-96% | ~30秒 |
| 小功能 | 5-10 MB | 78-89% | ~1分钟 |
| 大更新 | 15-20 MB | 56-67% | ~2分钟 |
| 完整包 | 45 MB | 0% | ~6分钟 |

---

## ⚙️ 服务器配置

### 测试服务器
- 地址: `http://127.0.0.1:8888`
- 用途: 本地测试
- 启动: `python test_update_local.py`

### 生产服务器
- 地址: `https://your-domain.com/xexunrtt/updates`
- 用途: 正式发布
- 需要: 修改 `auto_updater.py` 中的 `PRODUCTION_SERVER`

---

## 🐛 快速排错

| 问题 | 解决方案 |
|------|---------|
| "bsdiff4 not installed" | `pip install bsdiff4` |
| "服务器连接失败" | 检查测试服务器是否启动 |
| "哈希验证失败" | 重新生成补丁 |
| "未找到exe文件" | 确保已编译生成exe |
| 测试后无法恢复 | `python switch_update_server.py production` |

---

## 📚 详细文档

- 💡 **快速入门**: [AUTO_UPDATE_README.md](AUTO_UPDATE_README.md)
- 📖 **详细文档**: [AUTO_UPDATE_GUIDE.md](AUTO_UPDATE_GUIDE.md)
- 🧪 **测试指南**: [本地更新测试指南.md](本地更新测试指南.md)
- 📝 **实现总结**: [差异化更新实现总结.md](差异化更新实现总结.md)

---

## ✅ 检查清单

### 首次使用

- [ ] 安装依赖: `pip install bsdiff4 requests`
- [ ] 修改生产服务器地址（`auto_updater.py`）
- [ ] 运行本地测试验证功能
- [ ] 集成到主程序（`main_window.py`）

### 每次发布

- [ ] 编译新版本exe
- [ ] 切换到生产模式
- [ ] 生成补丁和version.json
- [ ] 上传到服务器
- [ ] 验证服务器连接
- [ ] 测试更新流程

---

## 🎉 开始使用

**现在就可以开始测试了！**

```bash
# Windows 用户（最简单）
quick_test_update.bat

# 所有平台
python switch_update_server.py test
python test_update_local.py
```

**祝测试顺利！** 🚀

