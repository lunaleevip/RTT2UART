# 打包前检查清单

## ⚠️ 重要提醒

每次修改 `.spec` 文件后，**必须**运行这些检查以避免模块缺失！

---

## 🔍 必须检查的模块

### 1. email 相关模块（requests 依赖）

**不能排除的模块**：
- ❌ `email`
- ❌ `email.*` (所有子模块)
- ❌ `quopri` ← 重要！email.charset 依赖
- ❌ `uu` ← email 编码需要
- ❌ `base64` ← email.encoders 依赖
- ❌ `binascii` ← base64 依赖
- ❌ `mimetypes` ← requests 可能需要

### 2. 更新功能模块

**必须在 hiddenimports 中**：
- ✅ `auto_updater`
- ✅ `update_dialog`
- ✅ `version`
- ✅ `requests`
- ✅ `urllib3`
- ✅ `bsdiff4`
- ✅ `certifi`
- ✅ `charset_normalizer`
- ✅ `idna`

### 3. email 所有子模块

**必须在 hiddenimports 中**：
- ✅ `email.mime`
- ✅ `email.mime.text`
- ✅ `email.mime.multipart`
- ✅ `email.parser`
- ✅ `email.message`
- ✅ `email.utils`
- ✅ `email.encoders`
- ✅ `email.header`
- ✅ `email.charset`
- ✅ `email._policybase`
- ✅ `email._parseaddr`
- ✅ `email._encoded_words`
- ✅ `email._header_value_parser`

---

## 🚀 检查脚本

### 1. 验证所有导入

```bash
python verify_imports.py
```

应该看到所有模块都是 ✅

### 2. 检查 email 依赖链

```bash
python check_email_deps.py
```

应该看到完整的依赖树都是 ✅

### 3. 检查 .spec 文件

手动检查 `XexunRTT_onefile_v2_2.spec`:

**excludes 中不应该有**：
```python
excludes=[
    # ... 其他模块 ...
    # 'email',  # ❌ 已注释，不排除
    # 'mimetypes',  # ❌ 已注释，不排除
    # 'base64',  # ❌ 已注释，不排除
    # 'binascii',  # ❌ 已注释，不排除
    # 'quopri',  # ❌ 已注释，不排除
    # 'uu',  # ❌ 已注释，不排除
]
```

**hiddenimports 中应该有**：
```python
hiddenimports=[
    # 自动更新依赖
    'bsdiff4',
    'requests',
    'urllib3',
    'charset_normalizer',
    'certifi',
    'idna',
    
    # email 模块及其子模块
    'email',
    'email.mime',
    'email.mime.text',
    # ... 更多子模块
    
    # 自定义模块
    'auto_updater',
    'update_dialog',
    'version',
]
```

---

## 📋 完整检查流程

### 步骤 1: 运行验证脚本

```bash
# 验证所有导入
python verify_imports.py

# 检查 email 依赖链
python check_email_deps.py
```

如果任一脚本失败，**不要编译**！先修复问题。

### 步骤 2: 清理缓存

```bash
# 删除旧的构建文件
rmdir /s /q build
rmdir /s /q dist

# 清理 PyInstaller 缓存
rmdir /s /q %LOCALAPPDATA%\pyinstaller
```

### 步骤 3: 编译

```bash
pyinstaller XexunRTT_onefile_v2_2.spec
```

### 步骤 4: 测试编译结果

```bash
# 清空日志
del %LOCALAPPDATA%\XexunRTT\logs\xexunrtt.log

# 运行 EXE
dist\XexunRTT_v2.4.exe
```

### 步骤 5: 检查日志

```bash
# 查看日志
type %LOCALAPPDATA%\XexunRTT\logs\xexunrtt.log

# 或使用查看器
view_log.bat
```

**必须看到**：
```
✅ Auto update module loaded successfully
Auto update check scheduled
```

**不应该看到**：
```
❌ Failed to load auto update module
ModuleNotFoundError: No module named 'xxx'
```

---

## ⚠️ 常见错误

### 错误 1: ModuleNotFoundError: No module named 'quopri'

**原因**：`quopri` 被排除了

**修复**：在 `.spec` 中注释掉：
```python
# 'quopri',  # ❌ 不要排除，email 依赖它
```

### 错误 2: ModuleNotFoundError: No module named 'email'

**原因**：`email` 被排除了

**修复**：在 `.spec` 中注释掉：
```python
# 'email',  # ❌ 不要排除，urllib3/requests 依赖它
```

### 错误 3: ModuleNotFoundError: No module named 'base64'

**原因**：`base64` 被排除了

**修复**：在 `.spec` 中注释掉：
```python
# 'base64',  # ❌ 不要排除，email.encoders 依赖它
```

### 错误 4: Auto update module not available

**原因**：更新模块没有被打包

**修复**：
1. 在 `main_window.py` 中直接导入：
   ```python
   import update_dialog
   import auto_updater
   ```

2. 在 `.spec` 的 `hiddenimports` 中添加：
   ```python
   'auto_updater',
   'update_dialog',
   'version',
   ```

---

## 🎯 快速检查命令

```bash
# 一键运行所有检查
python verify_imports.py && python check_email_deps.py && echo "All checks passed!"
```

如果输出：
```
All checks passed!
```

说明可以安全编译！

---

## 📝 修改 .spec 时的原则

### ❌ 不要排除的模块类型

1. **标准库的编码/解码模块**
   - `base64`, `binascii`, `quopri`, `uu`

2. **标准库的网络/邮件模块**
   - `email` 及其所有子模块
   - `mimetypes`
   - `http.client`

3. **第三方库的依赖**
   - `requests` → `urllib3` → `email` → `quopri`
   - `PySide6` → `base64` → `binascii`

### ✅ 可以安全排除的模块

1. **不使用的 GUI 框架**
   - `tkinter`
   - `matplotlib`

2. **数据科学库（不使用时）**
   - `numpy`, `pandas`, `scipy`
   - `tensorflow`, `torch`

3. **开发工具**
   - `pytest`, `unittest`
   - `pdb`, `profile`, `cProfile`

4. **文档工具**
   - `sphinx`, `doctest`

---

## 🔧 推荐的工作流程

### 修改 .spec 后

1. ✅ 运行 `python verify_imports.py`
2. ✅ 运行 `python check_email_deps.py`
3. ✅ 清理缓存 `rebuild_clean.bat`
4. ✅ 测试 EXE
5. ✅ 查看日志确认

### 每次发布前

1. ✅ 所有检查脚本通过
2. ✅ EXE 正常启动
3. ✅ 自动更新功能可用
4. ✅ 核心功能正常

---

## 📊 检查清单总结

打包前，确保：

- [ ] `python verify_imports.py` 通过
- [ ] `python check_email_deps.py` 通过
- [ ] `.spec` 的 `excludes` 中不包含必需模块
- [ ] `.spec` 的 `hiddenimports` 包含更新模块
- [ ] 清理了 build 和缓存目录
- [ ] 编译无错误
- [ ] EXE 启动正常
- [ ] 日志显示 "Auto update module loaded successfully"
- [ ] 5秒后显示 "Checking for updates from"

**全部完成后才能发布！** ✅

