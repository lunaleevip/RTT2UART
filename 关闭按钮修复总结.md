# å…³é—­æŒ‰é’®ä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆåœ¨åˆ‡æ¢åˆ°ç´§å‡‘æ¨¡å¼åï¼Œçª—å£å³ä¸Šè§’çš„å…³é—­å›¾æ ‡ï¼ˆâŒï¼‰è¢«ç¦ç”¨ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒå˜å·®ï¼Œåªèƒ½é€šè¿‡å³é”®èœå•æ¥å…³é—­ç¨‹åºã€‚

## ğŸ”§ é—®é¢˜æ ¹å› åˆ†æ

### çª—å£æ ‡å¿—å†²çª
å½“ä½¿ç”¨ `setWindowFlags()` è®¾ç½® `Qt.WindowStaysOnTopHint` æ—¶ï¼Œå¯èƒ½ä¼šè¦†ç›–æˆ–ä¸¢å¤±å…¶ä»–çª—å£æ ‡å¿—ï¼ŒåŒ…æ‹¬ï¼š
- `Qt.WindowSystemMenuHint` - ç³»ç»Ÿèœå•ï¼ˆå³é”®æ ‡é¢˜æ ï¼‰
- `Qt.WindowCloseButtonHint` - å…³é—­æŒ‰é’®

### åŸå§‹ä»£ç é—®é¢˜
```python
# é—®é¢˜ä»£ç  - å¯èƒ½ä¸¢å¤±å…¶ä»–çª—å£æ ‡å¿—
current_flags = self.windowFlags()
new_flags = current_flags | Qt.WindowStaysOnTopHint
self.setWindowFlags(new_flags)
```

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ`setWindowFlags()` å¯èƒ½ä¼šé‡ç½®çª—å£çš„é»˜è®¤è¡Œä¸ºï¼Œå¯¼è‡´å…³é—­æŒ‰é’®ä¸å¯ç”¨ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ˜ç¡®ä¿ç•™å…³é—­æŒ‰é’®æ ‡å¿—

#### è¿›å…¥ç´§å‡‘æ¨¡å¼
```python
# ä¿®å¤å - æ˜ç¡®ä¿ç•™å…³é—­æŒ‰é’®
try:
    current_flags = self.windowFlags()
    # ç¡®ä¿ä¿ç•™å…³é—­æŒ‰é’®å’Œå…¶ä»–å¿…è¦çš„çª—å£æ§ä»¶
    new_flags = current_flags | Qt.WindowStaysOnTopHint
    # æ˜ç¡®ä¿ç•™çª—å£ç³»ç»Ÿèœå•å’Œå…³é—­æŒ‰é’®
    new_flags |= Qt.WindowSystemMenuHint | Qt.WindowCloseButtonHint
    self.setWindowFlags(new_flags)
    self.show()  # é‡æ–°æ˜¾ç¤ºä»¥åº”ç”¨æ–°çš„çª—å£æ ‡å¿—
    logger.info("Window set to stay on top in compact mode with close button enabled")
except Exception as ex:
    logger.warning(f"Failed to set window stay-on-top: {ex}")
```

#### é€€å‡ºç´§å‡‘æ¨¡å¼
```python
# ä¿®å¤å - é€€å‡ºæ—¶ä¹Ÿä¿ç•™å…³é—­æŒ‰é’®
try:
    current_flags = self.windowFlags()
    new_flags = current_flags & ~Qt.WindowStaysOnTopHint
    # ç¡®ä¿ä¿ç•™å…³é—­æŒ‰é’®å’Œå…¶ä»–å¿…è¦çš„çª—å£æ§ä»¶
    new_flags |= Qt.WindowSystemMenuHint | Qt.WindowCloseButtonHint
    self.setWindowFlags(new_flags)
    self.show()  # é‡æ–°æ˜¾ç¤ºä»¥åº”ç”¨æ–°çš„çª—å£æ ‡å¿—
    logger.info("Window stay-on-top flag removed with close button enabled")
except Exception as ex:
    logger.warning(f"Failed to clear window stay-on-top: {ex}")
```

### 2. ä¿®å¤closeEventå’Œå¼ºåˆ¶é€€å‡º

#### closeEventä¸­çš„ä¿®å¤
```python
# å¦‚æœå¤„äºç´§å‡‘æ¨¡å¼ï¼Œå…ˆæ¸…é™¤çª—å£ç½®é¡¶æ ‡å¿—ï¼Œç¡®ä¿èƒ½æ­£å¸¸å…³é—­
if self.compact_mode:
    try:
        current_flags = self.windowFlags()
        new_flags = current_flags & ~Qt.WindowStaysOnTopHint
        # ç¡®ä¿ä¿ç•™å…³é—­æŒ‰é’®
        new_flags |= Qt.WindowSystemMenuHint | Qt.WindowCloseButtonHint
        self.setWindowFlags(new_flags)
        logger.info("Cleared window stay-on-top flag for clean shutdown")
    except Exception as ex:
        logger.warning(f"Error clearing window flags: {ex}")
```

#### å¼ºåˆ¶é€€å‡ºä¸­çš„ä¿®å¤
```python
# ç«‹å³æ¸…é™¤çª—å£ç½®é¡¶æ ‡å¿—
if self.compact_mode:
    current_flags = self.windowFlags()
    new_flags = current_flags & ~Qt.WindowStaysOnTopHint
    # ç¡®ä¿ä¿ç•™å…³é—­æŒ‰é’®
    new_flags |= Qt.WindowSystemMenuHint | Qt.WindowCloseButtonHint
    self.setWindowFlags(new_flags)
```

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰
- âŒ ç´§å‡‘æ¨¡å¼ä¸‹å…³é—­æŒ‰é’®ä¸å¯ç”¨
- âŒ ç”¨æˆ·åªèƒ½é€šè¿‡å³é”®èœå•é€€å‡º
- âŒ çª—å£ç½®é¡¶è®¾ç½®å¯èƒ½å½±å“å…¶ä»–åŠŸèƒ½
- âŒ ç”¨æˆ·ä½“éªŒä¸ä¸€è‡´

### ä¿®å¤å
- âœ… ç´§å‡‘æ¨¡å¼ä¸‹å…³é—­æŒ‰é’®æ­£å¸¸å¯ç”¨
- âœ… çª—å£ç½®é¡¶åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… ç³»ç»Ÿèœå•ä¿æŒå¯ç”¨
- âœ… ç”¨æˆ·ä½“éªŒä¸€è‡´ä¸”æµç•…

## ğŸ”¬ æŠ€æœ¯éªŒè¯

### çª—å£æ ‡å¿—çŠ¶æ€éªŒè¯
```
ğŸ“‹ åˆå§‹çª—å£æ ‡å¿—: 134279169
   SystemMenuHint: True
   CloseButtonHint: True
   StaysOnTopHint: False

ğŸ“‹ ç´§å‡‘æ¨¡å¼çª—å£æ ‡å¿—: 134541313
   SystemMenuHint: True    âœ…
   CloseButtonHint: True   âœ…
   StaysOnTopHint: True    âœ…

ğŸ“‹ æ­£å¸¸æ¨¡å¼çª—å£æ ‡å¿—: 134279169
   SystemMenuHint: True    âœ…
   CloseButtonHint: True   âœ…
   StaysOnTopHint: False   âœ…
```

### å…³é”®çª—å£æ ‡å¿—è¯´æ˜
- **WindowSystemMenuHint (8192)**: å¯ç”¨ç³»ç»Ÿèœå•ï¼ŒåŒ…å«å…³é—­ã€æœ€å°åŒ–ç­‰é€‰é¡¹
- **WindowCloseButtonHint (134217728)**: æ˜¾ç¤ºçª—å£å³ä¸Šè§’çš„å…³é—­æŒ‰é’®
- **WindowStaysOnTopHint (262144)**: çª—å£å§‹ç»ˆç½®é¡¶æ˜¾ç¤º

## ğŸ® ç”¨æˆ·ä½“éªŒæ”¹è¿›

### å¤šç§å…³é—­æ–¹å¼éƒ½å¯ç”¨
1. **å³ä¸Šè§’å…³é—­æŒ‰é’®**: âŒ ç›´æ¥ç‚¹å‡»ï¼ˆä¿®å¤åå¯ç”¨ï¼‰
2. **å³é”®èœå•**: å³é”® â†’ âš™ï¸ ç¨‹åºæ§åˆ¶ â†’ é€€å‡ºç¨‹åº
3. **å¿«æ·é”®**: `Ctrl+Alt+Q` å¼ºåˆ¶é€€å‡º
4. **ç³»ç»Ÿèœå•**: å³é”®æ ‡é¢˜æ  â†’ å…³é—­

### ä¸€è‡´çš„æ“ä½œä½“éªŒ
- **æ­£å¸¸æ¨¡å¼**: æ‰€æœ‰å…³é—­æ–¹å¼éƒ½å¯ç”¨
- **ç´§å‡‘æ¨¡å¼**: æ‰€æœ‰å…³é—­æ–¹å¼éƒ½å¯ç”¨ï¼ˆä¿®å¤åï¼‰
- **æ¨¡å¼åˆ‡æ¢**: æ— ç¼åˆ‡æ¢ï¼Œä¸å½±å“çª—å£æ§ä»¶

## ğŸ› ï¸ æŠ€æœ¯å®ç°ç»†èŠ‚

### çª—å£æ ‡å¿—ç®¡ç†æœ€ä½³å®è·µ
```python
def set_window_flags_safely(self, new_flags):
    """å®‰å…¨è®¾ç½®çª—å£æ ‡å¿—ï¼Œç¡®ä¿ä¿ç•™å¿…è¦çš„æ§ä»¶"""
    try:
        # ç¡®ä¿å§‹ç»ˆä¿ç•™åŸºæœ¬çš„çª—å£æ§ä»¶
        essential_flags = Qt.WindowSystemMenuHint | Qt.WindowCloseButtonHint
        safe_flags = new_flags | essential_flags
        
        self.setWindowFlags(safe_flags)
        self.show()  # é‡æ–°æ˜¾ç¤ºä»¥åº”ç”¨æ ‡å¿—
        
        return True
    except Exception as ex:
        logger.warning(f"Failed to set window flags: {ex}")
        return False
```

### çª—å£æ ‡å¿—ç»„åˆç­–ç•¥
```python
# è¿›å…¥ç´§å‡‘æ¨¡å¼
base_flags = self.windowFlags()
compact_flags = base_flags | Qt.WindowStaysOnTopHint | Qt.WindowSystemMenuHint | Qt.WindowCloseButtonHint

# é€€å‡ºç´§å‡‘æ¨¡å¼  
base_flags = self.windowFlags()
normal_flags = (base_flags & ~Qt.WindowStaysOnTopHint) | Qt.WindowSystemMenuHint | Qt.WindowCloseButtonHint
```

## ğŸ§ª æµ‹è¯•è¦†ç›–

### æµ‹è¯•åœºæ™¯
1. âœ… **åˆå§‹çŠ¶æ€**: å…³é—­æŒ‰é’®å¯ç”¨
2. âœ… **è¿›å…¥ç´§å‡‘æ¨¡å¼**: å…³é—­æŒ‰é’®ä¿æŒå¯ç”¨ï¼Œçª—å£ç½®é¡¶
3. âœ… **é€€å‡ºç´§å‡‘æ¨¡å¼**: å…³é—­æŒ‰é’®å¯ç”¨ï¼Œçª—å£å–æ¶ˆç½®é¡¶
4. âœ… **å¤šæ¬¡åˆ‡æ¢**: æ¨¡å¼åˆ‡æ¢ä¸å½±å“æŒ‰é’®åŠŸèƒ½
5. âœ… **ç¨‹åºå…³é—­**: å„ç§å…³é—­æ–¹å¼éƒ½æ­£å¸¸å·¥ä½œ

### è‡ªåŠ¨åŒ–æµ‹è¯•
```python
def test_close_button_availability():
    # æ£€æŸ¥åˆå§‹çŠ¶æ€
    initial_flags = window.windowFlags()
    assert bool(initial_flags & Qt.WindowCloseButtonHint)
    
    # è¿›å…¥ç´§å‡‘æ¨¡å¼
    window._toggle_compact_mode()
    compact_flags = window.windowFlags()
    assert bool(compact_flags & Qt.WindowCloseButtonHint)
    assert bool(compact_flags & Qt.WindowStaysOnTopHint)
    
    # é€€å‡ºç´§å‡‘æ¨¡å¼
    window._toggle_compact_mode()
    normal_flags = window.windowFlags()
    assert bool(normal_flags & Qt.WindowCloseButtonHint)
    assert not bool(normal_flags & Qt.WindowStaysOnTopHint)
```

## ğŸ“‹ ä½¿ç”¨å»ºè®®

### æ—¥å¸¸ä½¿ç”¨
- ç°åœ¨å¯ä»¥æ”¾å¿ƒä½¿ç”¨å³ä¸Šè§’çš„å…³é—­æŒ‰é’®
- ç´§å‡‘æ¨¡å¼å’Œæ­£å¸¸æ¨¡å¼ä¸‹ä½“éªŒå®Œå…¨ä¸€è‡´
- æ— éœ€è®°å¿†é¢å¤–çš„å…³é—­æ–¹å¼

### å¼€å‘å»ºè®®
- è®¾ç½®çª—å£æ ‡å¿—æ—¶å§‹ç»ˆä¿ç•™åŸºæœ¬æ§ä»¶æ ‡å¿—
- ä½¿ç”¨ try-catch ä¿æŠ¤çª—å£æ ‡å¿—æ“ä½œ
- æä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•ä»¥ä¾¿é—®é¢˜æ’æŸ¥

### å¤‡ç”¨æ–¹æ¡ˆ
å³ä½¿åœ¨æç«¯æƒ…å†µä¸‹å…³é—­æŒ‰é’®ä»ç„¶ä¸å¯ç”¨ï¼Œç”¨æˆ·è¿˜æœ‰ä»¥ä¸‹é€‰æ‹©ï¼š
- å³é”®èœå• â†’ âš™ï¸ ç¨‹åºæ§åˆ¶ â†’ é€€å‡ºç¨‹åº
- å¿«æ·é”® `Ctrl+Alt+Q` å¼ºåˆ¶é€€å‡º
- å³é”®æ ‡é¢˜æ  â†’ å…³é—­

## ğŸ¯ æ€»ç»“

é€šè¿‡æ˜ç¡®ä¿ç•™ `Qt.WindowSystemMenuHint` å’Œ `Qt.WindowCloseButtonHint` æ ‡å¿—ï¼ŒæˆåŠŸä¿®å¤äº†ç´§å‡‘æ¨¡å¼ä¸‹å…³é—­æŒ‰é’®è¢«ç¦ç”¨çš„é—®é¢˜ã€‚ç°åœ¨ç”¨æˆ·å¯ä»¥åœ¨ä»»ä½•æ¨¡å¼ä¸‹éƒ½ä½¿ç”¨ç†Ÿæ‚‰çš„å…³é—­æŒ‰é’®æ¥é€€å‡ºç¨‹åºï¼Œå¤§å¤§æ”¹å–„äº†ç”¨æˆ·ä½“éªŒã€‚

---

*å…³é—­æŒ‰é’®é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼Œç´§å‡‘æ¨¡å¼ä¸‹çš„ç”¨æˆ·ä½“éªŒä¸æ­£å¸¸æ¨¡å¼ä¿æŒä¸€è‡´*
