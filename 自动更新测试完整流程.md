# 自动更新测试完整流程

## ✅ 问题已找到并修复！

### 🐛 根本原因

从日志文件发现：
```
2025-10-18 17:59:05,780 - [WARNING] (main_window.py:1368) - Auto update module not available
```

**自动更新模块没有被打包进 EXE！**

---

## 🔧 修复内容

在 `XexunRTT_onefile_v2_2.spec` 中添加：

```python
hiddenimports=[
    # ... 其他模块 ...
    'auto_updater',    # ✅ 新增
    'update_dialog',   # ✅ 新增
    'version',         # ✅ 新增
]
```

---

## 🚀 完整测试流程

### 步骤 1: 清理并重新编译

```bash
rebuild_clean.bat
```

### 步骤 2: 清空日志（查看新日志）

```bash
del %LOCALAPPDATA%\XexunRTT\logs\xexunrtt.log
```

### 步骤 3: 启动并监控日志

```bash
test_log_realtime.bat
```

会打开两个窗口：
- **程序窗口** - XexunRTT
- **日志监控窗口** - 实时显示日志

---

## 📊 期望看到的日志

### 🟢 启动日志（立即显示）

```
======================================================================
XexunRTT Starting...
Log file: C:\Users\xxx\AppData\Local\XexunRTT\logs\xexunrtt.log
Python version: 3.13.6 ...
Frozen: True  👈 确认是编译后的 EXE
======================================================================
Window initialized with ID: ...
```

### 🟢 自动更新调度（启动时）

```
Auto update check scheduled  👈 应该看到这行（不是 "not available"）
```

**如果看到的是**：
```
[WARNING] Auto update module not available  ❌ 说明模块仍未打包
```

### 🟢 更新检查（5秒后）

```
Using default production server: http://sz.xexun.com:18891/uploads/xexunrtt/updates/win
Checking for updates from: http://sz.xexun.com:18891/uploads/xexunrtt/updates/win/version.json
Current file hash: 341b0e3cda3d5280...
✅ Current file integrity verified
Found patch from 2.4 to 2.4.1
Patch size: 420102 bytes (vs full: 56560020 bytes)
Found update: 2.4.1  👈 发现更新！
```

### 🟢 更新对话框弹出

程序界面应该弹出更新对话框，显示：
- 新版本：2.4.1
- 更新类型：增量补丁
- 补丁大小：420 KB
- 节省流量：99.3%

---

## 🔍 验证方法

### 方法 1: 查看日志监控窗口

等待 5-10 秒，应该能看到更新检查的日志滚动输出。

### 方法 2: 查看日志文件

```bash
view_log.bat
```

选择 `5` 搜索关键字 `"update"` 或 `"Found patch"`

### 方法 3: 搜索特定日志

```bash
# 搜索 "Auto update"
view_log.bat -> 5 -> "Auto update"

# 应该看到:
# Auto update check scheduled  ✅
# 而不是:
# Auto update module not available  ❌
```

---

## ⚠️ 可能的问题

### 问题 1: 仍然显示 "module not available"

**原因**：编译缓存没有清理

**解决**：
```bash
# 删除 build 目录
rmdir /s /q build

# 删除 PyInstaller 缓存
rmdir /s /q %LOCALAPPDATA%\pyinstaller

# 重新编译
pyinstaller XexunRTT_onefile_v2_2.spec
```

### 问题 2: 导入错误

**日志中可能看到**：
```
[ERROR] Failed to check for updates: No module named 'xxx'
```

**解决**：检查 `requirements.txt` 中是否包含所有依赖：
```
bsdiff4>=1.2.0
requests>=2.25.0
```

### 问题 3: 网络连接失败

**日志中看到**：
```
[ERROR] Failed to check for updates: HTTPConnectionPool...
```

**原因**：
- 无法连接到服务器
- 防火墙阻止

**解决**：
- 检查网络连接
- 检查防火墙设置
- 在浏览器中访问：http://sz.xexun.com:18891/uploads/xexunrtt/updates/win/version.json

---

## 📝 完整测试清单

- [ ] 1. 运行 `rebuild_clean.bat` 重新编译
- [ ] 2. 清空日志文件
- [ ] 3. 运行 `test_log_realtime.bat`
- [ ] 4. 查看日志监控窗口
- [ ] 5. 确认看到 `Auto update check scheduled`（不是 "not available"）
- [ ] 6. 等待 5 秒
- [ ] 7. 确认看到 `Checking for updates from:`
- [ ] 8. 确认看到 `Current file hash:`
- [ ] 9. 确认看到 `Found patch from 2.4 to 2.4.1`
- [ ] 10. 确认更新对话框弹出

---

## 🎯 最终验证

### 成功标志

**日志中应该包含**：
```
✅ Auto update check scheduled
✅ Using default production server: http://sz.xexun.com:18891/...
✅ Checking for updates from: ...
✅ Current file hash: ...
✅ Found patch from 2.4 to 2.4.1
✅ Found update: 2.4.1
```

**程序界面**：
```
✅ 弹出更新对话框
✅ 显示版本信息
✅ 显示更新内容
✅ 显示补丁大小
```

### 失败标志

如果看到以下任一项，说明还有问题：
```
❌ Auto update module not available
❌ No module named 'auto_updater'
❌ No module named 'update_dialog'
❌ No module named 'requests'
❌ No module named 'bsdiff4'
```

---

## 💡 调试技巧

### 1. 实时查看日志

两个终端窗口：
- 终端 1：`tail_log.bat` - 实时监控日志
- 终端 2：运行 EXE

### 2. 搜索关键字

在 `view_log.bat` 中搜索：
- `Auto update` - 查看更新模块是否加载
- `Checking for updates` - 查看是否开始检查
- `Found patch` - 查看是否找到补丁
- `ERROR` - 查看是否有错误
- `WARNING` - 查看是否有警告

### 3. 查看最后 50 行

```bash
view_log.bat -> 2
```

快速查看最近的日志

---

## 🎉 现在开始测试！

```bash
# 1. 重新编译（包含修复）
rebuild_clean.bat

# 2. 清空旧日志
del %LOCALAPPDATA%\XexunRTT\logs\xexunrtt.log

# 3. 启动并监控
test_log_realtime.bat

# 4. 等待 5 秒，查看日志
```

**这次应该能看到完整的自动更新流程了！** 🚀

