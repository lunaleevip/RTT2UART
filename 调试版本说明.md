# 调试版本说明

## 🐛 为什么需要调试版本？

当编译后的 EXE 出现问题时，正式版本不会显示控制台日志，难以诊断问题。调试版本会：

- ✅ 显示控制台窗口
- ✅ 输出所有日志信息
- ✅ 显示异常堆栈
- ✅ 帮助快速定位问题

---

## 🔧 如何编译调试版本

### 方法 1: 使用批处理脚本（推荐）

```bash
build_debug.bat
```

这个脚本会：
1. 激活虚拟环境
2. 使用 `XexunRTT_debug.spec` 编译
3. 生成 `XexunRTT_v2.4_debug.exe`

### 方法 2: 手动编译

```bash
# 激活虚拟环境
env\Scripts\activate

# 编译调试版本
pyinstaller XexunRTT_debug.spec
```

---

## 🚀 运行调试版本

直接双击运行生成的 EXE 文件：

```
dist\XexunRTT_v2.4_debug.exe
```

**会看到两个窗口**：
1. **控制台窗口**（黑色）- 显示所有日志
2. **主程序窗口** - 正常的 GUI 界面

---

## 📊 控制台输出示例

### 正常启动

```
配置文件加载成功: C:\Users\xxx\AppData\Roaming\XexunRTT\config.ini
System locale: zh_CN, language: Language.Chinese, country: Country.China
[OK] Chinese translation loaded successfully
2025-10-18 17:38:32,665 - [INFO] (main_window.py:974) - Window initialized
2025-10-18 17:38:33,144 - [INFO] (main_window.py:1336) - Auto update check scheduled
```

### 自动更新检查

```
2025-10-18 17:38:38,144 - [INFO] (auto_updater.py:87) - Using production server: http://sz.xexun.com:18891/...
2025-10-18 17:38:38,165 - [INFO] (auto_updater.py:245) - Checking for updates from: http://...
2025-10-18 17:38:38,254 - [INFO] (auto_updater.py:254) - Current file hash: 97f14d40bb69a200...
2025-10-18 17:38:38,281 - [INFO] (auto_updater.py:281) - ✅ Current file integrity verified
2025-10-18 17:38:38,320 - [INFO] (auto_updater.py:319) - Found patch from 2.4 to 2.4.1
2025-10-18 17:38:38,320 - [INFO] (auto_updater.py:320) - Patch size: 420102 bytes
2025-10-18 17:38:38,321 - [INFO] (update_dialog.py:315) - Found update: 2.4.1
```

### 更新检查失败

```
2025-10-18 17:38:38,350 - [ERROR] (auto_updater.py:350) - Error checking for updates: [Errno 2] No such file or directory
Traceback (most recent call last):
  File "auto_updater.py", line 254, in check_for_updates
    current_hash = self._calculate_file_hash(self.current_exe)
  File "auto_updater.py", line 165, in _calculate_file_hash
    with open(file_path, 'rb') as f:
FileNotFoundError: [Errno 2] No such file or directory: 'E:\\coder\\RTT2UART2\\XexunRTT.exe'
```

---

## 🎯 调试自动更新问题

### 步骤 1: 编译调试版本

```bash
build_debug.bat
```

### 步骤 2: 运行并观察日志

运行 `dist\XexunRTT_v2.4_debug.exe`，注意观察控制台输出：

**检查以下关键信息**：

1. **版本信息**
   ```
   Current version: 2.4
   ```

2. **服务器地址**
   ```
   Using production server: http://sz.xexun.com:18891/uploads/xexunrtt/updates/win
   ```

3. **文件哈希**
   ```
   Current file hash: 97f14d40bb69a200...
   ```

4. **版本比较**
   ```
   Found patch from 2.4 to 2.4.1
   ```

5. **错误信息**
   ```
   ERROR: ...
   ```

### 步骤 3: 等待 5 秒

自动更新检查会在程序启动 **5秒后** 触发。等待并观察控制台输出。

### 步骤 4: 保存日志

如果需要保存日志供后续分析：

```bash
# 方法 1: 重定向到文件
dist\XexunRTT_v2.4_debug.exe > debug.log 2>&1

# 方法 2: 在控制台中右键 -> 全选 -> 复制
```

---

## 🔍 常见问题诊断

### 问题 1: 没有看到任何更新日志

**可能原因**：
- 更新检查抛出异常被捕获
- 网络连接失败
- 服务器地址错误

**检查方法**：
在控制台搜索关键字：
- `Auto update check`
- `check_for_updates`
- `AutoUpdater`

### 问题 2: 显示"没有可用更新"

**可能原因**：
- 版本号比较错误
- 当前版本已是最新
- 文件哈希验证失败

**检查方法**：
查看日志中的：
```
Current version: X.X
Server version: X.X
```

### 问题 3: 文件哈希错误

**症状**：
```
ERROR: No such file or directory: XexunRTT.exe
```

**原因**：
开发环境中 EXE 文件不存在

**解决**：
这是正常的，在编译后的 EXE 中不会有这个问题

---

## 📋 调试版本 vs 正式版本

| 特性 | 调试版本 | 正式版本 |
|------|---------|---------|
| **控制台窗口** | ✅ 显示 | ❌ 隐藏 |
| **日志输出** | ✅ 控制台 | ❌ 无（除非配置文件日志） |
| **UPX 压缩** | ❌ 禁用 | ✅ 启用 |
| **文件大小** | 较大 | 较小 |
| **启动速度** | 较慢 | 较快 |
| **适用场景** | 开发调试 | 用户发布 |
| **文件名后缀** | `_debug.exe` | `.exe` |

---

## 💡 进阶技巧

### 1. 增强日志级别

编辑 `main_window.py`，在程序开始处添加：

```python
import logging
logging.basicConfig(
    level=logging.DEBUG,  # 改为 DEBUG 级别
    format='%(asctime)s - [%(levelname)s] (%(filename)s:%(lineno)d) - %(message)s'
)
```

### 2. 添加自动更新专属日志

编辑 `auto_updater.py`，添加更多 `logger.debug()` 输出：

```python
logger.debug(f"Comparing versions: {server_version} vs {self.current_version}")
logger.debug(f"Compare result: {result}")
```

### 3. 日志重定向到文件

如果控制台日志太多，可以重定向到文件：

```python
# 在 main_window.py 开头添加
import logging
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - [%(levelname)s] - %(message)s',
    handlers=[
        logging.FileHandler('xexunrtt_debug.log', encoding='utf-8'),
        logging.StreamHandler()  # 同时输出到控制台
    ]
)
```

### 4. 只输出更新相关日志

```python
# 设置特定模块的日志级别
import logging

# 其他模块使用 WARNING 级别
logging.basicConfig(level=logging.WARNING)

# 只有自动更新模块使用 DEBUG 级别
logging.getLogger('auto_updater').setLevel(logging.DEBUG)
logging.getLogger('update_dialog').setLevel(logging.DEBUG)
```

---

## ⚠️ 注意事项

1. **不要发布调试版本**
   - 调试版本会显示控制台窗口
   - 用户体验不好
   - 文件较大

2. **调试完成后切换回正式版本**
   ```bash
   pyinstaller XexunRTT_onefile_v2_2.spec
   ```

3. **保护敏感信息**
   - 调试日志可能包含敏感信息
   - 不要在公开场合分享完整日志
   - 分享前删除敏感路径、IP 等

4. **性能影响**
   - 调试版本未压缩，启动较慢
   - 日志输出会影响性能
   - 仅用于调试，不用于性能测试

---

## 🎯 快速开始

想快速查看自动更新日志？

```bash
# 1. 编译调试版本
build_debug.bat

# 2. 运行
dist\XexunRTT_v2.4_debug.exe

# 3. 等待 5 秒，观察控制台输出
```

就是这么简单！ 🚀

---

## 📞 需要帮助？

如果遇到问题：

1. **查看控制台完整输出**
2. **搜索 ERROR 或 WARNING 关键字**
3. **复制相关日志**
4. **提供以下信息**：
   - 当前版本号
   - 服务器地址
   - 完整错误堆栈
   - 操作步骤

