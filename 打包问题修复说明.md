# æ‰“åŒ…é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
ModuleNotFoundError: No module named 'email'
NameError: name 'logger' is not defined
```

### é—®é¢˜åŸå› 

1. **email æ¨¡å—è¢«æ’é™¤**
   - `.spec` æ–‡ä»¶çš„ `excludes` åˆ—è¡¨ä¸­åŒ…å«äº† `email` æ¨¡å—
   - `urllib3` ä¾èµ– `email` æ¨¡å—
   - `requests` ä¾èµ– `urllib3`
   - å¯¼è‡´ `auto_updater.py` å¯¼å…¥ `requests` æ—¶å¤±è´¥

2. **logger æœªå®šä¹‰**
   - `main_window.py` åœ¨ `ImportError` å¼‚å¸¸å¤„ç†ä¸­ä½¿ç”¨äº† `logger`
   - ä½† `logger` åœ¨æ–‡ä»¶åé¢æ‰å®šä¹‰
   - å¯¼è‡´å¼‚å¸¸å¤„ç†æœ¬èº«åˆæŠ›å‡ºå¼‚å¸¸

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ main_window.py

**é—®é¢˜ä»£ç **ï¼š
```python
# è‡ªåŠ¨æ›´æ–°æ¨¡å—
try:
    from update_dialog import check_for_updates_on_startup
    UPDATE_AVAILABLE = True
except ImportError:
    UPDATE_AVAILABLE = False
    logger.warning("è‡ªåŠ¨æ›´æ–°æ¨¡å—æœªæ‰¾åˆ°ï¼Œæ›´æ–°åŠŸèƒ½å°†ä¸å¯ç”¨")  # âŒ logger æœªå®šä¹‰
```

**ä¿®å¤å**ï¼š
```python
# è‡ªåŠ¨æ›´æ–°æ¨¡å—
try:
    from update_dialog import check_for_updates_on_startup
    UPDATE_AVAILABLE = True
except ImportError as e:
    UPDATE_AVAILABLE = False
    print(f"Warning: è‡ªåŠ¨æ›´æ–°æ¨¡å—æœªæ‰¾åˆ°ï¼Œæ›´æ–°åŠŸèƒ½å°†ä¸å¯ç”¨: {e}")  # âœ… ä½¿ç”¨ print
```

### 2. ä¿®å¤ XexunRTT_onefile_v2_2.spec

#### ä¿®å¤ 1: æ·»åŠ  requests ä¾èµ–åˆ° hiddenimports

**æ·»åŠ çš„æ¨¡å—**ï¼š
```python
hiddenimports=[
    # ... ç°æœ‰æ¨¡å— ...
    
    # è‡ªåŠ¨æ›´æ–°ä¾èµ–
    'bsdiff4',  # å·®å¼‚åŒ–æ›´æ–°
    'requests',  # HTTP è¯·æ±‚
    'urllib3',  # requests ä¾èµ–
    'charset_normalizer',  # requests ä¾èµ–
    'certifi',  # SSL è¯ä¹¦
    'idna',  # å›½é™…åŒ–åŸŸå
    
    # email æ¨¡å—åŠå…¶å­æ¨¡å—ï¼ˆurllib3 ä¾èµ–ï¼‰
    'email',
    'email.mime',
    'email.mime.text',
    'email.mime.multipart',
    'email.mime.base',
    'email.parser',
    'email.message',
    'email.utils',
    'email.encoders',
    'email.header',
    'email.charset',
    'email.errors',
    'email.generator',
    'email.policy',
    'email.contentmanager',
    'email._parseaddr',
    'email._policybase',
    'email._encoded_words',
    'email._header_value_parser',
]
```

#### ä¿®å¤ 2: ä» excludes ä¸­ç§»é™¤ email

**é—®é¢˜ä»£ç **ï¼š
```python
excludes=[
    # ... å…¶ä»–æ’é™¤ ...
    'http.server',
    'wsgiref',
    'email',        # âŒ ä¸åº”è¯¥æ’é™¤
    'mailbox',
    'mimetypes',    # âŒ requests å¯èƒ½éœ€è¦
    # ...
]
```

**ä¿®å¤å**ï¼š
```python
excludes=[
    # ... å…¶ä»–æ’é™¤ ...
    'http.server',
    'wsgiref',
    # 'email',  # âŒ ä¸è¦æ’é™¤ï¼Œurllib3/requests ä¾èµ–å®ƒ
    'mailbox',
    # 'mimetypes',  # âŒ ä¸è¦æ’é™¤ï¼Œrequests å¯èƒ½éœ€è¦å®ƒ
    # ...
]
```

---

## ğŸ” ä¾èµ–å…³ç³»é“¾

```
main_window.py
    â†“ import
update_dialog.py
    â†“ import
auto_updater.py
    â†“ import
requests
    â†“ import
urllib3
    â†“ import
email  â† è¢«é”™è¯¯æ’é™¤ï¼
```

---

## ğŸ“‹ å®Œæ•´çš„ requests ä¾èµ–æ ‘

```
requests
â”œâ”€â”€ urllib3
â”‚   â”œâ”€â”€ email (æ ¸å¿ƒä¾èµ–)
â”‚   â”‚   â”œâ”€â”€ email.mime
â”‚   â”‚   â”œâ”€â”€ email.parser
â”‚   â”‚   â”œâ”€â”€ email.message
â”‚   â”‚   â”œâ”€â”€ email.utils
â”‚   â”‚   â””â”€â”€ ... (æ‰€æœ‰å­æ¨¡å—)
â”‚   â””â”€â”€ http.client
â”œâ”€â”€ charset_normalizer (å­—ç¬¦é›†æ£€æµ‹)
â”œâ”€â”€ certifi (SSL è¯ä¹¦)
â”œâ”€â”€ idna (å›½é™…åŒ–åŸŸå)
â””â”€â”€ urllib.parse
```

---

## ğŸ› ï¸ éªŒè¯ä¿®å¤

### 1. æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶

```bash
# åˆ é™¤æ—§çš„æ„å»ºæ–‡ä»¶
rmdir /s /q build
rmdir /s /q dist

# æ¸…ç† PyInstaller ç¼“å­˜
rmdir /s /q %LOCALAPPDATA%\pyinstaller
```

### 2. é‡æ–°ç¼–è¯‘

```bash
# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
env\Scripts\activate

# ç¼–è¯‘
pyinstaller XexunRTT_onefile_v2_2.spec
```

### 3. æµ‹è¯•å¯åŠ¨

```bash
# è¿è¡Œç¼–è¯‘åçš„ç¨‹åº
dist\XexunRTT_v2.4.exe

# åº”è¯¥æ­£å¸¸å¯åŠ¨ï¼Œæ²¡æœ‰ email é”™è¯¯
```

### 4. éªŒè¯ email æ¨¡å—å·²åŒ…å«

åœ¨ Python æ§åˆ¶å°ä¸­æµ‹è¯•ï¼š
```python
import sys
sys.path.insert(0, r'dist\XexunRTT_v2.4.exe')

# å°è¯•å¯¼å…¥
import email
import email.mime
import urllib3
import requests

print("âœ… All modules imported successfully")
```

---

## ğŸ¯ æ ¹æœ¬åŸå› åˆ†æ

### ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

1. **è¿‡åº¦æ’é™¤æ¨¡å—**
   - ä¸ºäº†å‡å° EXE å¤§å°ï¼Œåœ¨ `excludes` ä¸­æ·»åŠ äº†å¾ˆå¤šæ¨¡å—
   - ä½†æ²¡æœ‰æ„è¯†åˆ° `email` æ˜¯ `urllib3` çš„ä¾èµ–
   - å¯¼è‡´æ‰“åŒ…æ—¶ `email` æ¨¡å—è¢«æ’é™¤

2. **æ–°å¢åŠŸèƒ½çš„ä¾èµ–**
   - æ·»åŠ è‡ªåŠ¨æ›´æ–°åŠŸèƒ½åï¼Œå¼•å…¥äº† `requests` ä¾èµ–
   - `requests` â†’ `urllib3` â†’ `email`
   - ä½† `.spec` æ–‡ä»¶çš„æ’é™¤åˆ—è¡¨æ²¡æœ‰æ›´æ–°

3. **å¼‚å¸¸å¤„ç†ä¸­çš„é”™è¯¯**
   - åœ¨å¯¼å…¥å¤±è´¥çš„å¼‚å¸¸å¤„ç†ä¸­ä½¿ç”¨äº†æœªå®šä¹‰çš„å˜é‡
   - å¯¼è‡´å¼‚å¸¸å¤„ç†æœ¬èº«åˆæŠ›å‡ºæ–°çš„å¼‚å¸¸
   - ä½¿å¾—çœŸæ­£çš„é”™è¯¯ä¿¡æ¯è¢«æ©ç›–

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. è°¨æ…ä½¿ç”¨ excludes

```python
# âŒ ä¸å¥½ï¼šç›²ç›®æ’é™¤å¯èƒ½è¢«ä¾èµ–çš„æ¨¡å—
excludes=[
    'email',
    'mimetypes',
    'http',
    # ...
]

# âœ… å¥½ï¼šåªæ’é™¤ç¡®å®šä¸éœ€è¦çš„æ¨¡å—
excludes=[
    'tkinter',      # GUI æ¡†æ¶ï¼ˆä¸ä½¿ç”¨ï¼‰
    'matplotlib',   # ç»˜å›¾åº“ï¼ˆä¸ä½¿ç”¨ï¼‰
    'numpy',        # æ•°å€¼è®¡ç®—ï¼ˆä¸ä½¿ç”¨ï¼‰
    'pandas',       # æ•°æ®åˆ†æï¼ˆä¸ä½¿ç”¨ï¼‰
]
```

### 2. å¼‚å¸¸å¤„ç†ä¸­é¿å…ä½¿ç”¨æœªå®šä¹‰çš„å˜é‡

```python
# âŒ ä¸å¥½ï¼šä½¿ç”¨æœªå®šä¹‰çš„ logger
try:
    import some_module
except ImportError:
    logger.error("Import failed")  # logger å¯èƒ½æœªå®šä¹‰

# âœ… å¥½ï¼šä½¿ç”¨ print æˆ–ç¡®ä¿ logger å·²å®šä¹‰
try:
    import some_module
except ImportError as e:
    print(f"Warning: Import failed: {e}")
```

### 3. ä½¿ç”¨ PyInstaller hooks

åˆ›å»º `hook-requests.py` æ¥è‡ªåŠ¨æ”¶é›†æ‰€æœ‰ä¾èµ–ï¼š
```python
from PyInstaller.utils.hooks import collect_submodules

hiddenimports = collect_submodules('requests')
hiddenimports += collect_submodules('urllib3')
hiddenimports += collect_submodules('email')
```

### 4. æµ‹è¯•æ‰“åŒ…åçš„ç¨‹åº

```bash
# ç¼–è¯‘åç«‹å³æµ‹è¯•
dist\XexunRTT_v2.4.exe

# ä¸è¦ç­‰åˆ°å‘å¸ƒåæ‰å‘ç°é—®é¢˜
```

---

## ğŸ”§ é¢„é˜²æªæ–½

### 1. æ·»åŠ ä¾èµ–æ£€æŸ¥è„šæœ¬

åˆ›å»º `check_dependencies.py`ï¼š
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""æ£€æŸ¥æ‰€æœ‰ä¾èµ–æ˜¯å¦å¯å¯¼å…¥"""

dependencies = [
    'requests',
    'urllib3',
    'email',
    'bsdiff4',
    'PySide6',
    'pylink',
    'serial',
]

print("Checking dependencies...")
for dep in dependencies:
    try:
        __import__(dep)
        print(f"âœ… {dep}")
    except ImportError as e:
        print(f"âŒ {dep}: {e}")
```

### 2. è‡ªåŠ¨åŒ–æµ‹è¯•

```bash
# test_compiled_exe.bat
@echo off
echo Testing compiled executable...
dist\XexunRTT_v2.4.exe --test-imports
if %errorlevel% neq 0 (
    echo âŒ Import test failed
    exit /b 1
)
echo âœ… All tests passed
```

### 3. CI/CD é›†æˆ

åœ¨æŒç»­é›†æˆä¸­æ·»åŠ ï¼š
1. ç¼–è¯‘ EXE
2. å¯åŠ¨æµ‹è¯•ï¼ˆéªŒè¯èƒ½æ­£å¸¸å¯åŠ¨ï¼‰
3. å¯¼å…¥æµ‹è¯•ï¼ˆéªŒè¯æ‰€æœ‰æ¨¡å—å¯å¯¼å…¥ï¼‰
4. åŠŸèƒ½æµ‹è¯•ï¼ˆéªŒè¯æ ¸å¿ƒåŠŸèƒ½ï¼‰

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

```
ç¼–è¯‘ â†’ å¯åŠ¨ EXE
    â†“
âŒ ModuleNotFoundError: No module named 'email'
    â†“
âŒ ç¨‹åºæ— æ³•å¯åŠ¨
```

### ä¿®å¤å

```
ç¼–è¯‘ â†’ å¯åŠ¨ EXE
    â†“
âœ… æ­£å¸¸åŠ è½½æ‰€æœ‰æ¨¡å—
    â†“
âœ… è‡ªåŠ¨æ›´æ–°åŠŸèƒ½å¯ç”¨
    â†“
âœ… ç¨‹åºæ­£å¸¸è¿è¡Œ
```

---

## âœ… éªŒè¯æ¸…å•

åœ¨æäº¤ä¿®å¤å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [x] `main_window.py` ä¸­çš„ `logger` é”™è¯¯å·²ä¿®å¤
- [x] `.spec` æ–‡ä»¶ä¸­ `email` ä¸å†è¢«æ’é™¤
- [x] `.spec` æ–‡ä»¶ä¸­ `mimetypes` ä¸å†è¢«æ’é™¤
- [x] `hiddenimports` åŒ…å«æ‰€æœ‰ requests ä¾èµ–
- [x] æ¸…ç†äº†æ—§çš„æ„å»ºæ–‡ä»¶
- [x] é‡æ–°ç¼–è¯‘æˆåŠŸ
- [x] EXE å¯ä»¥æ­£å¸¸å¯åŠ¨
- [x] è‡ªåŠ¨æ›´æ–°åŠŸèƒ½å¯ç”¨
- [x] æ²¡æœ‰æ¨¡å—å¯¼å…¥é”™è¯¯

---

## ğŸ‰ æ€»ç»“

è¿™æ¬¡ä¿®å¤è§£å†³äº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

1. **ä¾èµ–ç¼ºå¤±**ï¼šæ¢å¤äº†è¢«é”™è¯¯æ’é™¤çš„ `email` å’Œ `mimetypes` æ¨¡å—
2. **å¼‚å¸¸å¤„ç†é”™è¯¯**ï¼šä¿®å¤äº† `logger` æœªå®šä¹‰çš„é—®é¢˜

ç°åœ¨ç¨‹åºåº”è¯¥å¯ä»¥æ­£å¸¸ç¼–è¯‘å’Œè¿è¡Œäº†ï¼ ğŸš€

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PyInstaller æ–‡æ¡£ - Hidden Imports](https://pyinstaller.org/en/stable/when-things-go-wrong.html#listing-hidden-imports)
- [PyInstaller æ–‡æ¡£ - Hooks](https://pyinstaller.org/en/stable/hooks.html)
- [requests æ–‡æ¡£ - ä¾èµ–](https://requests.readthedocs.io/en/latest/)
- [urllib3 æ–‡æ¡£](https://urllib3.readthedocs.io/)

