# 服务器空间优化策略

## 📦 **问题**

> 上传到服务器的文件，如果空间不足，是不是只需要保留升级到最新版本的补丁和最新的版本EXE即可？

**答案：是的！** ✅

---

## 🎯 **推荐策略对比**

### **策略 1：完整部署**（默认）

```
updates/
├── version.json                      (5 KB)
├── XexunRTT_v2.4.1.exe              (56 MB) ← 最新
├── XexunRTT_v2.4.exe                (56 MB) ← 旧版
├── XexunRTT_v2.3.exe                (55 MB) ← 更旧
├── patch_2.3_to_2.4.patch          (400 KB)
└── patch_2.4_to_2.4.1.patch        (420 KB) ← 最新

总计: ~167 MB
```

**特点**：
- 🟢 所有版本用户都能增量更新
- 🔴 占用空间大

---

### **策略 2：精简部署**（推荐 ⭐）

```
updates/
├── version.json                      (5 KB)
├── XexunRTT_v2.4.1.exe              (56 MB) ← 最新完整版
└── patch_2.4_to_2.4.1.patch        (420 KB) ← 最新补丁

总计: ~56 MB
```

**特点**：
- 🟢 空间占用小（节省 66%）
- 🟢 最近版本用户可增量更新（快速）
- 🟡 老版本用户需全量更新（但总能成功）

**节省空间：110+ MB**

---

### **策略 3：极简部署**

```
updates/
├── version.json                      (5 KB)
└── XexunRTT_v2.4.1.exe              (56 MB) ← 只有完整版

总计: ~56 MB
```

**特点**：
- 🟢 空间占用最小
- 🟢 维护最简单
- 🔴 所有用户都需全量更新（56MB）

---

## 🔄 **更新逻辑说明**

### 客户端更新流程

```python
def check_for_updates(self):
    current_version = "2.4"
    new_version = "2.4.1"
    
    # 1. 尝试查找补丁
    patch_key = f"{current_version}_{new_version}"
    
    if patch_key in server_patches:
        # ✅ 找到补丁 → 增量更新（快）
        download_size = 420 KB
        download(patch_file)
        apply_patch()
    else:
        # ⚠️ 没有补丁 → 完整更新（慢但可靠）
        download_size = 56 MB
        download(full_exe)
        replace_exe()
```

### 用户场景对比

| 用户版本 | 服务器文件 | 更新方式 | 下载量 | 耗时 |
|---------|-----------|---------|-------|------|
| **2.4** | 精简部署（有补丁） | 🚀 增量更新 | 420 KB | ~1秒 |
| **2.4** | 极简部署（无补丁） | 🐢 全量更新 | 56 MB | ~30秒 |
| **2.3** | 精简部署 | 🐢 全量更新 | 56 MB | ~30秒 |
| **全新安装** | 任何部署 | 📥 全量下载 | 56 MB | ~30秒 |

**结论**：
- **推荐精简部署**：平衡空间和体验
- 最近版本用户（2.4 → 2.4.1）享受快速更新
- 老版本用户（2.3 → 2.4.1）需全量下载，但总能成功

---

## 🛠️ **如何实现精简部署**

### 方法 1：使用精简部署脚本（推荐）

```bash
# 只保留最新1个补丁
quick_deploy_minimal.bat dist\XexunRTT_v2.4.1.exe "修复更新失败问题"
```

**自动完成**：
- ✅ 生成补丁（2.4 → 2.4.1）
- ✅ 复制最新 EXE
- ✅ 更新 version.json
- ✅ **删除旧补丁文件**

---

### 方法 2：手动指定保留数量

```bash
# 保留1个补丁（精简）
python deploy_update.py dist\XexunRTT_v2.4.1.exe --max-patches 1

# 保留0个补丁（极简）
python deploy_update.py dist\XexunRTT_v2.4.1.exe --max-patches 0

# 保留3个补丁（默认）
python deploy_update.py dist\XexunRTT_v2.4.1.exe --max-patches 3
```

---

### 方法 3：手动清理（不推荐）

在 `updates/` 目录中：

1. **保留**：
   - `version.json` （必需）
   - `XexunRTT_v2.4.1.exe` （最新完整版）
   - `patch_2.4_to_2.4.1.patch` （最新补丁，可选）

2. **删除**：
   - 所有旧版本的 EXE
   - 所有旧的补丁文件

---

## 📊 **空间对比分析**

### 实际测试数据（Windows 平台）

```
完整部署（3个版本 + 3个补丁）:
├── 3 个 EXE × 56 MB   = 168 MB
├── 3 个补丁 × 400 KB  = 1.2 MB
└── version.json       = 5 KB
总计: ~169 MB

精简部署（1个版本 + 1个补丁）:
├── 1 个 EXE           = 56 MB
├── 1 个补丁           = 420 KB
└── version.json       = 5 KB
总计: ~56 MB

极简部署（1个版本）:
├── 1 个 EXE           = 56 MB
└── version.json       = 5 KB
总计: ~56 MB
```

**节省**：
- 精简 vs 完整：节省 113 MB（67%）
- 极简 vs 完整：节省 113 MB（67%）

---

## 🎯 **选择建议**

### 根据服务器空间选择

| 可用空间 | 推荐策略 | 保留补丁数 | 特点 |
|---------|---------|-----------|------|
| **< 100 MB** | 极简部署 | 0 | 空间最小，所有用户全量更新 |
| **100-200 MB** | 精简部署 ⭐ | 1 | 平衡空间和体验 |
| **> 200 MB** | 标准部署 | 2-3 | 最佳用户体验 |
| **> 500 MB** | 完整部署 | 不限 | 所有版本增量更新 |

### 根据用户分布选择

**用户集中在最近版本**：
- ✅ 精简部署（1个补丁）
- 大部分用户享受快速更新

**用户版本分散**：
- ✅ 标准部署（2-3个补丁）
- 更多用户可增量更新

**新产品/用户较少**：
- ✅ 极简部署（0个补丁）
- 维护简单，空间最小

---

## 🔧 **version.json 结构**

### 精简部署的 version.json

```json
{
  "version": "2.4.1",
  "hash": "888f1a05079c8835...",
  "file": "XexunRTT_v2.4.1.exe",
  "size": 56582953,
  "release_notes": "修复更新失败问题",
  "history": [
    {
      "version": "2.4",
      "hash": "e32f7dd4c5627235...",
      "timestamp": "2025-10-20T08:00:00"
    },
    {
      "version": "2.4.1",
      "hash": "888f1a05079c8835...",
      "timestamp": "2025-10-20T10:00:00"
    }
  ],
  "patches": {
    "2.4_2.4.1": {
      "file": "patch_2.4_to_2.4.1.patch",
      "size": 420428,
      "from_version": "2.4",
      "to_version": "2.4.1",
      "from_hash": "e32f7dd4c5627235..."
    }
  }
}
```

**说明**：
- `history`: 保留所有版本的哈希记录（用于完整性验证）
- `patches`: 只保留最新1个补丁

---

## 📝 **上传到服务器**

### 精简部署上传清单

```bash
# 必需文件
updates/version.json                  # ← 必需
updates/XexunRTT_v2.4.1.exe          # ← 必需

# 可选文件（推荐保留）
updates/patch_2.4_to_2.4.1.patch     # ← 可选，但推荐

# 无需上传
updates/XexunRTT_v2.4.exe            # ← 删除旧版本
updates/patch_2.3_to_2.4.patch       # ← 删除旧补丁
```

### 上传步骤

```bash
# 1. 生成精简部署文件
quick_deploy_minimal.bat dist\XexunRTT_v2.4.1.exe

# 2. 检查 updates 目录
dir updates

# 3. 上传到服务器
#    http://sz.xexun.com:18891/uploads/xexunrtt/updates/win/
#    - version.json
#    - XexunRTT_v2.4.1.exe
#    - patch_2.4_to_2.4.1.patch

# 4. 验证 URL 可访问
#    http://sz.xexun.com:18891/uploads/xexunrtt/updates/win/version.json
```

---

## ✅ **验证和测试**

### 1. 验证服务器文件

```bash
# 检查 version.json
curl http://sz.xexun.com:18891/uploads/xexunrtt/updates/win/version.json

# 检查完整 EXE
curl -I http://sz.xexun.com:18891/uploads/xexunrtt/updates/win/XexunRTT_v2.4.1.exe

# 检查补丁文件
curl -I http://sz.xexun.com:18891/uploads/xexunrtt/updates/win/patch_2.4_to_2.4.1.patch
```

### 2. 测试更新（从 2.4 → 2.4.1）

```bash
# 运行旧版本
dist\XexunRTT_v2.4.exe

# 应该弹出更新提示
# 点击"立即更新"
# 应该下载补丁（420KB）而不是完整版（56MB）
```

### 3. 测试全量更新（从 2.3 → 2.4.1）

```bash
# 如果用户是 2.3 版本
# 应该下载完整版（56MB）
# 因为没有 2.3 → 2.4.1 的补丁
```

---

## 📈 **统计数据**

### 更新流量节省

假设 1000 个用户从 2.4 更新到 2.4.1：

**完整更新**：
```
1000 用户 × 56 MB = 56 GB 流量
```

**增量更新**：
```
1000 用户 × 420 KB = 420 MB 流量
```

**节省流量**：
```
56 GB - 420 MB = 55.58 GB（节省 99.25%）
```

### 服务器存储节省

**完整部署**：
```
3 个版本 + 3 个补丁 = ~169 MB
```

**精简部署**：
```
1 个版本 + 1 个补丁 = ~56 MB
```

**节省存储**：
```
169 MB - 56 MB = 113 MB（节省 67%）
```

---

## 🚀 **快速开始**

```bash
# 1. 编译新版本
rebuild_clean.bat

# 2. 精简部署（推荐）
quick_deploy_minimal.bat dist\XexunRTT_v2.4.1.exe "修复更新失败问题"

# 3. 上传 updates 目录到服务器
#    - version.json
#    - XexunRTT_v2.4.1.exe
#    - patch_2.4_to_2.4.1.patch

# 4. 测试更新
dist\XexunRTT_v2.4.exe
```

---

## 📚 **相关文档**

- `部署更新使用指南.md` - 详细的部署步骤
- `AUTO_UPDATE_GUIDE.md` - 自动更新技术文档
- `更新失败问题修复.md` - 更新失败问题排查

---

## ✅ **总结**

| 问题 | 答案 |
|-----|------|
| **空间不足时可以只保留最新版本吗？** | ✅ 可以 |
| **需要保留补丁吗？** | 🟡 推荐保留1个最新补丁 |
| **旧版本用户还能更新吗？** | ✅ 可以（全量下载） |
| **会影响更新速度吗？** | 🟡 老版本慢，最近版本快 |
| **推荐哪种策略？** | ⭐ 精简部署（1个补丁） |

**推荐配置**：
```bash
quick_deploy_minimal.bat  # 只保留1个补丁
```

**空间占用**：~56 MB（节省 67%）

**用户体验**：最近版本快速更新，老版本全量下载但可靠

