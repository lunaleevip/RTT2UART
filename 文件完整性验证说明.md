# 文件完整性验证功能说明

## 🔐 概述

为了防止程序文件被恶意篡改、病毒感染或意外损坏，XexunRTT自动更新系统现在包含了**文件完整性验证**功能。

---

## 🎯 功能特性

### 1. 多重验证机制

更新检测不再只依赖版本号，而是采用多层验证：

```
检查更新流程:
1️⃣ 计算当前文件的 SHA256 哈希值
2️⃣ 与服务器记录的哈希值比对
3️⃣ 验证文件完整性
4️⃣ 根据验证结果决定更新策略
```

### 2. 三种验证状态

| 状态 | 说明 | 处理方式 |
|------|------|---------|
| ✅ **verified** | 文件完整，未被篡改 | 正常更新流程 |
| ⚠️ **modified** | 文件被修改或损坏 | 强制完整更新 + 警告提示 |
| ❓ **unknown** | 服务器无该版本记录 | 允许更新，记录警告 |

---

## 🔍 验证逻辑

### 检测场景

#### 场景1: 版本号相同，哈希不同

```
当前版本: v2.2.0
服务器版本: v2.2.0
当前哈希: abc123...
期望哈希: def456...

结果: ⚠️ 文件已被修改！提示用户修复
```

**用户看到**:
```
⚠️ 文件完整性警告
检测到当前程序文件的完整性校验失败！
文件可能已被修改、损坏或感染病毒。
强烈建议立即修复以确保程序安全运行。

[立即修复] [稍后提醒]
```

#### 场景2: 版本号不同，但当前文件哈希不匹配

```
当前版本: v2.2.0
服务器版本: v2.3.0
当前v2.2.0哈希: abc123...
服务器记录的v2.2.0哈希: def456...

结果: ⚠️ 文件被篡改！强制完整更新
```

**日志输出**:
```
⚠️  Current file has been modified! Forcing full update.
   Expected hash for v2.2.0 not found in server records
   Current hash: abc123def456...
```

**用户看到**:
```
⚠️ 检测到文件异常
当前文件的哈希值与服务器记录不匹配！
文件可能已被篡改或损坏。
建议更新到最新版本以确保安全。

版本: v2.2.0 → v2.3.0
更新类型: 完整更新
下载大小: 45.2 MB

[立即更新] [稍后提醒]
```

#### 场景3: 正常更新（完整性验证通过）

```
当前版本: v2.2.0
服务器版本: v2.3.0
当前哈希: abc123...
服务器记录的v2.2.0哈希: abc123...

结果: ✅ 完整性验证通过，正常更新
```

**日志输出**:
```
✅ Current file integrity verified
Found patch from 2.2.0 to 2.3.0
Patch size: 3.2 MB (vs full: 45.2 MB)
```

---

## 📊 哈希值来源

系统从以下三个地方查找历史版本的哈希值：

### 1. 当前最新版本

```json
{
  "version": "2.3.0",
  "hash": "a1b2c3d4...",
  "file": "XexunRTT_v2.3.0.exe",
  "size": 47456789
}
```

### 2. 历史版本记录

```json
{
  "history": [
    {
      "version": "2.2.0",
      "hash": "xyz9876...",
      "file": "XexunRTT_v2.2.0.exe",
      "size": 47123456
    },
    {
      "version": "2.1.3",
      "hash": "abc1234...",
      "file": "XexunRTT_v2.1.3.exe",
      "size": 46789012
    }
  ]
}
```

### 3. 补丁源文件哈希 ⭐ 新增

```json
{
  "patches": {
    "2.2.0_2.3.0": {
      "file": "patch_2.2.0_to_2.3.0.patch",
      "size": 3356789,
      "from_version": "2.2.0",
      "to_version": "2.3.0",
      "from_hash": "xyz9876..."  // ⭐ 新增：源文件哈希
    }
  }
}
```

---

## 🛡️ 安全优势

### 1. 防篡改检测

- ✅ 检测恶意修改（植入后门、病毒）
- ✅ 检测文件损坏（磁盘错误、传输错误）
- ✅ 检测版本伪造

### 2. 完整更新链

```
开发者编译 → 计算哈希 → 记录到version.json
    ↓
服务器存储 → version.json + exe + patch
    ↓
用户下载 → 验证当前文件 → 安全更新
    ↓
更新完成 → 再次验证 → 确保新文件完整
```

### 3. 多层保护

| 保护层 | 验证点 | 算法 |
|--------|-------|------|
| 第1层 | 更新前验证当前文件 | SHA256 |
| 第2层 | 下载后验证新文件 | SHA256 |
| 第3层 | 补丁应用后验证 | SHA256 |

---

## 🧪 测试完整性验证

### 测试1: 模拟文件损坏

```bash
# 1. 修改当前exe文件（模拟损坏）
# 用十六进制编辑器修改几个字节

# 2. 启动程序
python main_window.py

# 3. 观察结果
# 应该弹出完整性警告对话框
```

### 测试2: 版本伪造检测

```bash
# 1. 将新版本exe重命名为旧版本号
copy XexunRTT_v2.3.0.exe XexunRTT_v2.2.0.exe

# 2. 修改version.py中的版本号
# CURRENT_VERSION = "2.2.0"

# 3. 启动程序
python main_window.py

# 4. 观察结果
# 系统会检测到v2.2.0的哈希不匹配
```

### 测试3: 正常更新

```bash
# 1. 启动测试服务器
python test_update_local.py

# 2. 使用未修改的旧版本exe测试
python test_update_cli.py check

# 3. 观察日志
# 应该看到 "✅ Current file integrity verified"
```

---

## 📝 日志示例

### 正常情况

```log
INFO: Checking for updates from: http://127.0.0.1:8888/version.json
INFO: Current file hash: abc123def456...
INFO: ✅ Current file integrity verified
INFO: Found patch from 2.2.0 to 2.3.0
INFO: Patch size: 3356789 bytes (vs full: 47456789 bytes)
```

### 检测到篡改

```log
INFO: Checking for updates from: http://sz.xexun.com:18899/uploads/xexunrtt/updates/version.json
INFO: Current file hash: aaa111bbb222...
WARNING: ⚠️  Current file has been modified! Forcing full update.
WARNING:    Expected hash for v2.2.0 not found in server records
WARNING:    Current hash: aaa111bbb222...
```

### 版本匹配但哈希不同（需要修复）

```log
INFO: Current file hash: aaa111bbb222...
WARNING: ⚠️  Version matches but hash differs! File may be corrupted.
WARNING:    Current: aaa111bbb222...
WARNING:    Expected: abc123def456...
```

---

## 🔧 开发者集成

### 生成补丁时自动记录哈希

```python
# generate_patch.py 已自动实现
patch_size, old_hash = generate_patch(old_file, new_file, patch_file)

patches[patch_key] = {
    'file': patch_name,
    'size': patch_size,
    'from_version': old_version,
    'to_version': new_version,
    'from_hash': old_hash  # ⭐ 自动记录源文件哈希
}
```

### 更新version.json格式

```json
{
  "version": "2.3.0",
  "hash": "new_version_hash",
  "file": "XexunRTT_v2.3.0.exe",
  "size": 47456789,
  "patches": {
    "2.2.0_2.3.0": {
      "file": "patch_2.2.0_to_2.3.0.patch",
      "size": 3356789,
      "from_version": "2.2.0",
      "to_version": "2.3.0",
      "from_hash": "old_version_hash"  // ⭐ 关键：源文件哈希
    }
  },
  "history": [
    {
      "version": "2.2.0",
      "hash": "old_version_hash",     // ⭐ 历史版本哈希
      "file": "XexunRTT_v2.2.0.exe",
      "size": 47123456
    }
  ]
}
```

---

## ⚙️ 配置选项

目前完整性验证是**强制启用**的，无法关闭，以确保最高级别的安全性。

如果需要临时跳过验证（仅用于开发测试），可以修改代码：

```python
# auto_updater.py (不推荐在生产环境使用)
def check_for_updates(self):
    # ...
    # 临时注释掉完整性验证
    # integrity_check = self._verify_current_file_integrity(...)
    integrity_check = "verified"  # 强制通过
    # ...
```

---

## 🎯 总结

### 主要改进

1. ✅ **防篡改**: 检测文件是否被恶意修改
2. ✅ **防损坏**: 检测文件是否意外损坏
3. ✅ **用户提示**: 清晰的警告信息
4. ✅ **自动修复**: 提供一键修复选项
5. ✅ **完整记录**: 所有版本哈希都被保存

### 技术细节

- 算法: SHA256
- 验证时机: 每次检查更新
- 验证对象: 当前运行的exe文件
- 哈希存储: version.json (history + patches)

### 用户体验

- ✅ 正常情况: 无感知，自动验证
- ⚠️ 异常情况: 清晰警告，引导修复
- 🔒 安全保障: 多层验证，确保安全

---

## 📚 相关文件

- `auto_updater.py` - 核心验证逻辑
- `update_dialog.py` - 警告UI显示
- `generate_patch.py` - 哈希记录生成
- `test_update_local.py` - 测试环境支持
- `version.json` - 哈希值存储

---

**创建时间**: 2025-10-18  
**功能状态**: ✅ 已实现并测试

